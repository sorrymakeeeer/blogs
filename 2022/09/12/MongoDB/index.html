<!DOCTYPE html>
<html lang="zh-cn">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="MongoDB" />
    <meta name="hexo-theme-A4" content="v1.8.9" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.jpg">
    <title>Scofield</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--注意：首页既不是post也不是page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--返回顶部css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--目录-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery.min.css">


<meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
    
    
    <body>
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.jpg" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Scofield</a> 
            <span class="description">互联网搬砖人 | 瞎折腾爱好者</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">首页</a></li>
            
        
            
                <li><a href="/list/">文章</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--说明是文章post页面-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            MongoDB
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%88%9D%E8%AF%86MongoDB"><span class="post-toc-text">初识MongoDB</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%80-%E4%BB%8B%E7%BB%8D"><span class="post-toc-text">一.介绍</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%8C-%E4%BC%98%E5%8A%BF"><span class="post-toc-text">二.优势</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%89-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="post-toc-text">三.数据类型</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%9B%9B-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C"><span class="post-toc-text">四.基础操作</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%94-%E6%93%8D%E4%BD%9C%E7%AC%A6%EF%BC%88%E9%83%A8%E5%88%86%EF%BC%89"><span class="post-toc-text">五.操作符（部分）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%85%AD-%E5%85%B6%E4%BB%96"><span class="post-toc-text">六.其他</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%83-%E9%97%AE%E9%A2%98"><span class="post-toc-text">七. 问题</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#MongoDB-%E5%BA%94%E7%94%A8"><span class="post-toc-text">MongoDB 应用</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%80-NodeJs"><span class="post-toc-text">一. NodeJs</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%8C-Java"><span class="post-toc-text">二. Java</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%9B%B8%E5%85%B3%E6%B5%8B%E8%AF%95sql"><span class="post-toc-text">相关测试sql</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%80-%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C"><span class="post-toc-text">一.基础操作</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%8C-%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="post-toc-text">二.聚合查询</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%89-%E7%9B%B8%E5%85%B3%E5%AE%9E%E9%99%85SQL"><span class="post-toc-text">三. 相关实际SQL</span></a></li></ol></li></ol></li></ol>
            
        
        <div class=".article-gallery"><h2 id="初识MongoDB"><a href="#初识MongoDB" class="headerlink" title="初识MongoDB"></a>初识MongoDB</h2><h4 id="一-介绍"><a href="#一-介绍" class="headerlink" title="一.介绍"></a>一.介绍</h4><ol>
<li>非关系型数据库，文档类型数据库</li>
<li>数据结构为bson的格式</li>
<li><a target="_blank" rel="noopener" href="https://docs.mongoing.com/">官方中文文档</a></li>
</ol>
<h4 id="二-优势"><a href="#二-优势" class="headerlink" title="二.优势"></a>二.优势</h4><ol>
<li>高并发读写 </li>
<li>高效率存储和访问</li>
<li>高可扩展性和高可用性</li>
</ol>
<h4 id="三-数据类型"><a href="#三-数据类型" class="headerlink" title="三.数据类型"></a>三.数据类型</h4><p>MongoDB将数据记录存储为BSON文档。BSON是<a target="_blank" rel="noopener" href="https://docs.mongodb.com/v4.2/reference/glossary/#term-json">JSON</a>文档的二进制表示形式。</p>
<a href="/Users/administrator/Library/Application Support/typora-user-images/image-20210622140018895.png" title="image-20210622140018895" class="gallery-item" style="box-shadow: none;"> <img src="/Users/administrator/Library/Application Support/typora-user-images/image-20210622140018895.png" alt="image-20210622140018895"></a>

<p>MongoDB文档由字段和值对组成，字段的值可以是任何BSON数据类型，包括其他文档，数组和文档数组。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">               <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">"5099803df3f4948bd2f98391"</span>),</span><br><span class="line">               <span class="attr">name</span>: { <span class="attr">first</span>: <span class="string">"Alan"</span>, <span class="attr">last</span>: <span class="string">"Turing"</span> },</span><br><span class="line">               <span class="attr">birth</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">'Jun 23, 1912'</span>),</span><br><span class="line">               <span class="attr">death</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">'Jun 07, 1954'</span>),</span><br><span class="line">               <span class="attr">contribs</span>: [ <span class="string">"Turing machine"</span>, <span class="string">"Turing test"</span>, <span class="string">"Turingery"</span> ],</span><br><span class="line">               views : <span class="title class_">NumberLong</span>(<span class="number">1250000</span>)</span><br><span class="line">            }</span><br><span class="line"><span class="comment">// 存储在集合中的每个文档都需要一个唯一的 _id字段作为主键。如果插入的文档省略了该_id字段，则MongoDB驱动程序会自动为该_id字段生成一个ObjectId。</span></span><br><span class="line"><span class="number">1.</span> 默认情况下，<span class="title class_">MongoDB</span> 在创建集合期间会在_id字段上创建唯一索引。</span><br><span class="line"><span class="number">2.</span> 该_id字段始终是文档中的第一个字段。如果服务器首先接收到没有该_id字段的文档，则服务器会将字段移到开头。</span><br><span class="line"><span class="number">3.</span> 该_id字段可以包含除数组之外的任何<span class="variable constant_">BSON</span>数据类型的值。</span><br></pre></td></tr></tbody></table></figure>

<h4 id="四-基础操作"><a href="#四-基础操作" class="headerlink" title="四.基础操作"></a>四.基础操作</h4><ol>
<li><p>数据库操作</p>
<p><code>show databases</code> 查看数据库</p>
<p><code>use databaseName</code> 使用数据库</p>
<p><code>use databaseNameNotExist</code> 隐式创建数据库/集合</p>
<p><code>db.dropDatabase()</code> 删除数据库</p>
<p><code>show collections</code> 查看集合</p>
<p><code>db.createCollection(collectionName)</code> 创建集合</p>
<p><code>db.getCollection(collectionName)</code> 查看集合</p>
<p><code>db.collectionName.drop</code> 删除集合</p>
</li>
<li><p>增删改查</p>
<ul>
<li><p>增加  </p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增加数据</span></span><br><span class="line">`db.collectionName.insert(<span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span>name<span class="punctuation">:</span>'jack Ma'<span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span>)`</span><br><span class="line"><span class="comment">// for循环增加数据</span></span><br><span class="line">for(var i =<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)<span class="punctuation">{</span></span><br><span class="line">    db.collectionName.insert(<span class="punctuation">{</span>age<span class="punctuation">:</span>i<span class="punctuation">}</span>)</span><br><span class="line"><span class="punctuation">}</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>删除 </p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">`db.collectionName.remove(filter<span class="punctuation">,</span><span class="punctuation">[</span>isDeleteOne<span class="punctuation">]</span>)`</span><br><span class="line">isDeleteOne<span class="punctuation">:</span>是否删除一条</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>编辑 </p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">`db.collectionName.update(filter<span class="punctuation">,</span>newData<span class="punctuation">,</span><span class="punctuation">[</span>isInsert<span class="punctuation">,</span>isMany<span class="punctuation">]</span>)`</span><br><span class="line">isInsert<span class="punctuation">:</span>条件匹配不到数据时是否新增数据，默认<span class="literal"><span class="keyword">false</span></span></span><br><span class="line">isMany<span class="punctuation">:</span>是否修改匹配到的所有数据，默认<span class="literal"><span class="keyword">false</span></span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>查询  </p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询</span></span><br><span class="line">`db.collectionName.find(filter<span class="punctuation">,</span><span class="punctuation">[</span>selectColumn<span class="punctuation">]</span>)`</span><br><span class="line">`db.collectionName.findOne(filter<span class="punctuation">,</span><span class="punctuation">[</span>selectColumn<span class="punctuation">]</span>)` <span class="comment">//返回查询到的第一个结果</span></span><br><span class="line">`db.collectionName.find(filter<span class="punctuation">,</span><span class="punctuation">[</span>selectColumn<span class="punctuation">]</span>).pretty()`<span class="comment">// 格式化查询结果</span></span><br><span class="line"><span class="comment">// $where自定义函数条件查询 函数返回值boolean</span></span><br><span class="line">db.collectionName.find(<span class="punctuation">{</span>$where<span class="punctuation">:</span>function()<span class="punctuation">{</span>return this.age&gt;<span class="number">11</span><span class="punctuation">}</span>)</span><br><span class="line">                        </span><br><span class="line">selectColumn<span class="punctuation">:</span><span class="punctuation">{</span>name<span class="punctuation">:</span><span class="number">0</span><span class="punctuation">}</span> <span class="comment">// 查询除name列外所有数据</span></span><br><span class="line">selectColumn<span class="punctuation">:</span><span class="punctuation">{</span>name<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">}</span> <span class="comment">// 只查询name列数据</span></span><br><span class="line">db.collectionName.find(<span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span><span class="punctuation">{</span>name<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">}</span>)      </span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</li>
<li><p>分页排序</p>
<ul>
<li>分页:limit,skip</li>
</ul>
 <figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">collectionName</span>.<span class="title function_">find</span>().<span class="title function_">limit</span>(<span class="number">10</span>).<span class="title function_">skip</span>(<span class="number">0</span>) <span class="comment">//查询前10条</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>排序:sort</li>
</ul>
 <figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>：升序；-<span class="number">1</span>：降序</span><br><span class="line"><span class="comment">// 升序排序</span></span><br><span class="line">db.<span class="property">collectionName</span>.<span class="title function_">find</span>().<span class="title function_">sort</span>({<span class="attr">age</span>:<span class="number">1</span>})</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>统计个数</p>
<ul>
<li>count</li>
</ul>
 <figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">统计结果集中文档条数</span><br><span class="line">db.<span class="property">collectionName</span>.<span class="title function_">count</span>({<span class="attr">age</span>:{<span class="attr">$gte</span>:<span class="number">11</span>}})</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>消除重复</p>
<ul>
<li>distinct</li>
</ul>
 <figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">对数据进行去重</span><br><span class="line">db.<span class="property">collctionName</span>.<span class="title function_">distinct</span>(<span class="string">'去重字段'</span>,filter)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>批量操作</p>
<ul>
<li>bulkWrite()</li>
</ul>
 <figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 参数 [ &lt;operation 1&gt;, &lt;operation 2&gt;, ... ],{      writeConcern : &lt;document&gt;,  ordered : &lt;boolean&gt;   }</span><br><span class="line">2. 该方法可以实现对文档数据的批量新增/修改/删除</span><br><span class="line">3. writeConcern ：可以配置超时时间</span><br><span class="line">4. ordered：批量操作是否有序执行，默认情况下是有序执行。</span><br><span class="line">5. 支持的批量操作 </span><br><span class="line">			{ insertOne : &lt;document&gt; },</span><br><span class="line">      { updateOne : &lt;document&gt; },</span><br><span class="line">      { updateMany : &lt;document&gt; },</span><br><span class="line">      { replaceOne : &lt;document&gt; },</span><br><span class="line">      { deleteOne : &lt;document&gt; },</span><br><span class="line">      { deleteMany : &lt;document&gt; }</span><br><span class="line">      // 示例：事件源导入</span><br><span class="line">      db.collectionName.bulkWrite([</span><br><span class="line">        "insertOne":{ "document" :{"_id" : 4, "char" : "Dithras", "class" : "barbarian", "lvl" : 4}},</span><br><span class="line">    	"updateOne":{</span><br><span class="line">            "filter":{"_id":5},</span><br><span class="line">             "update":{$set:{"_id" : 5, "char" : "x", "class" : "xx", "lvl" : 14}},</span><br><span class="line">             "upsert":true // 条件匹配无结果则插入数据</span><br><span class="line">        },</span><br><span class="line">      	{ "deleteOne" :</span><br><span class="line">            { "filter" : { "char" : "Brisbane"} }</span><br><span class="line">         },</span><br><span class="line">         { "replaceOne" :</span><br><span class="line">            {</span><br><span class="line">               "filter" : { "char" : "Meldane" },</span><br><span class="line">               "replacement" : { "char" : "Tanys", "class" : "oracle", "lvl" : 4 }</span><br><span class="line">            }</span><br><span class="line">         }</span><br><span class="line">    ],</span><br><span class="line">        {</span><br><span class="line">        // 副本集中所有必需节点确认写入操作所需的总时间大于wtimeout，则在wtimeout 时间过去时将显示以下writeConcernError。</span><br><span class="line">          writeConcern : { w : "majority", wtimeout : 100 }，</span><br><span class="line">          ordered:false</span><br><span class="line">        }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<h4 id="五-操作符（部分）"><a href="#五-操作符（部分）" class="headerlink" title="五.操作符（部分）"></a>五.操作符（部分）</h4><ol>
<li><p>比较操作符</p>
<ul>
<li>$gt</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">大于 {age:{$gt:18}}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$lt</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">小于 {<span class="attr">age</span>:{<span class="attr">$lt</span>:<span class="number">15</span>}}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$gte</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">大于等于 {<span class="attr">age</span>:{<span class="attr">$gte</span>:<span class="number">22</span>}}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$lte</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">小于等于 {<span class="attr">age</span>:{<span class="attr">$lte</span>:<span class="number">30</span>}}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$ne</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不等于 {<span class="attr">age</span>:{<span class="attr">$ne</span>:<span class="number">90</span>}}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$eq</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">匹配字段值等于指定值的文档</span><br><span class="line">{ &lt;field&gt;: { <span class="attr">$eq</span>: &lt;value&gt; } }</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$in</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">匹配字段值等于指定数组中的任何值</span><br><span class="line">{<span class="attr">age</span>:{<span class="attr">$in</span>:[<span class="number">10</span>,<span class="number">4</span>,<span class="number">45</span>]}}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$nin</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">字段值不在指定数组或者不存在</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$regex</li>
</ul>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">模糊查询</span><br><span class="line">{<span class="attr">name</span>:{<span class="attr">$regex</span>:<span class="string">'张三'</span>}}</span><br></pre></td></tr></tbody></table></figure>


</li>
<li><p>逻辑操作符</p>
<ul>
<li>$and</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">文档满足所有的表达式</span><br><span class="line">{ <span class="attr">$and</span>: [ { &lt;expression1&gt; }, { &lt;expression2&gt; } , ... , { &lt;expressionN&gt; } ] }</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$or</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">文档至少满足其中的一个表达式</span><br><span class="line">或 {<span class="attr">age</span>:{<span class="attr">$or</span>:{ &lt;expression1&gt; }, { &lt;expression2&gt; }, ... , { &lt;expressionN&gt; } }}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$nor</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">字段值不匹配所有的表达式的文档，包括那些不包含这些字段的文档</span><br><span class="line">{ <span class="attr">$nor</span>: [ { &lt;expression1&gt; }, { &lt;expression2&gt; }, ...  { &lt;expressionN&gt; } ] }</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$not</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">字段值不匹配表达式或者字段值不存在</span><br><span class="line">{ <span class="attr">field</span>: { <span class="attr">$not</span>: { &lt;operator-expression&gt; } } }</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$exists</li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">当的值为<span class="literal"><span class="keyword">true</span></span>时，则匹配数据库中含有field这个字段的文档，也包括field这个字段为空的文档。如果的值为<span class="literal"><span class="keyword">false</span></span>，那么查询只返回不包括该field该字段的文档。简单的说，$exists 就是判断一个字段是否存在。</span><br><span class="line"><span class="punctuation">{</span> field<span class="punctuation">:</span> <span class="punctuation">{</span> $exists<span class="punctuation">:</span> <span class="punctuation">{</span> &lt;boolean&gt; <span class="punctuation">}</span> <span class="punctuation">}</span> <span class="punctuation">}</span></span><br><span class="line">    <span class="attr">"deviceRoomId"</span> <span class="punctuation">:</span> <span class="string">"60505f8757c8395cd81798a3"</span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>数组操作符</p>
<ul>
<li>$elemMatch</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如果array字段中的元素符合所有$elemMatch条件，则选择文档</span><br><span class="line">{ &lt;field&gt;: { <span class="attr">$elemMatch</span>: { &lt;query1&gt;, &lt;query2&gt;, ... } } }</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$size</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">匹配数组字段元素个数等于指定数量的文档</span><br><span class="line">db.<span class="property">collection</span>.<span class="title function_">find</span>( { <span class="attr">field</span>: { <span class="attr">$size</span>: <span class="number">2</span> } } );</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>更新操作符</p>
<ul>
<li>$inc</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">递增:{<span class="attr">$inc</span>:{<span class="attr">age</span>:<span class="number">3</span>}} <span class="comment">// age增加3</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$rename</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">修改字段的值</span><br><span class="line">{ <span class="attr">$set</span>: { &lt;field1&gt;: &lt;value1&gt;, ... } }</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$setOnInsert</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">经常与$set，upsert一起使用</span><br><span class="line">upsert为<span class="literal">true</span>时，有插入文档操作时插入指定字段值</span><br><span class="line">db.<span class="property">collection</span>.<span class="title function_">update</span>(</span><br><span class="line">   &lt;query&gt;,</span><br><span class="line">   { <span class="attr">$setOnInsert</span>: { &lt;field1&gt;: &lt;value1&gt;, ... } },</span><br><span class="line">   { <span class="attr">upsert</span>: <span class="literal">true</span> }</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$set</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">修改列值:{<span class="attr">$set</span>:{<span class="attr">age</span>:<span class="number">3</span>}} <span class="comment">// age改为3</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$unset</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">删除指定字段</span><br><span class="line">{ <span class="attr">$unset</span>: { &lt;field1&gt;: <span class="string">""</span>, ... } } </span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">更新指定数组的第一个元素</span><br><span class="line"> { <span class="string">"&lt;array&gt;.$"</span> : value } </span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$addToSet</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">数组字段增加一个值</span><br><span class="line">{ <span class="attr">$addToSet</span>: { &lt;field1&gt;: &lt;value1&gt;, ... } }</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$pop</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">删除数组字段中的第一个或最后一个元素</span><br><span class="line">{ <span class="attr">$pop</span>: { &lt;field&gt;: <span class="language-xml">&lt;-1 | 1&gt;, ... } }</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$push</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">向数组中追加值</span><br><span class="line">{ <span class="attr">$push</span>: { &lt;field1&gt;: &lt;value1&gt;, ... } }</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$pull</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">符合条件的值将被删除</span><br><span class="line">{ <span class="attr">$pull</span>: { &lt;field1&gt;: &lt;value|condition&gt;, &lt;field2&gt;: &lt;value|condition&gt;, ... } }</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>聚合管道操作符/表达式</p>
<p>管道：将前命令的输出结果作为下一个命令的输入</p>
<p>在一个管道对文档进行多个阶段的操作，输出需要的结果</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">collectionName</span>.<span class="title function_">aggregate</span>([{管道操作符:{表达式}}])</span><br><span class="line"><span class="comment">// 表达式</span></span><br><span class="line">$sum/$avg/$max/$min/$push</span><br><span class="line">$first/<span class="attr">$last</span>:从数组中获取第一个/最后一个值</span><br><span class="line"><span class="attr">$push</span>:将操作结果push到数组中</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$project</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">将字段重新命名，增加删除字段 </span><br><span class="line">支持下列运算符</span><br><span class="line"><span class="number">1.</span> 加法（$add）、减法（$subtract）、乘法（$multipy）、除法（$divide）、求模（$mod）</span><br><span class="line"><span class="number">2.</span> 关系运算：大小比较（<span class="string">"$cmp"</span>）、等于（<span class="string">"$eq"</span>）、大于（<span class="string">"$gt"</span>）、大于等于（<span class="string">"$gte"</span>）、小于（<span class="string">"$le"</span>）、小于等于（<span class="string">"$lte"</span>）、不等于（<span class="string">"$ne"</span>）、判断 <span class="literal">null</span> （<span class="string">"$ifNull"</span>），这些返回值都是 boolean 值类型的。</span><br><span class="line"><span class="number">3.</span> 逻辑运算：与（<span class="string">"$and"</span>）、或（<span class="string">"$or"</span>）、非 （<span class="string">"$not"</span>）</span><br><span class="line"><span class="number">4.</span> 字符串操作：连接（<span class="string">"$concat"</span>）、截取（<span class="string">"$substr"</span>）、转小写（<span class="string">"$toLower"</span>）</span><br></pre></td></tr></tbody></table></figure>



<ul>
<li>$match</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">类似mysql的where  条件过滤</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$lookup</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">左外链接 left outer join</span><br><span class="line">{</span><br><span class="line">   <span class="attr">$lookup</span>:</span><br><span class="line">     {</span><br><span class="line">       <span class="attr">from</span>: &lt;collection to join&gt;, //	同一个数据库下等待被Join的集合。</span><br><span class="line">       localField: &lt;field from the input documents&gt;, //源集合中的match值</span><br><span class="line">       foreignField: &lt;field from the documents of the "from" collection&gt;, //待Join的集合的match值</span><br><span class="line">       as: &lt;output array field&gt; //为输出文档的新增值命名</span><br><span class="line">     }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$unwind</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">数组展开 将一个数组的元素展开产生多个文档记录</span><br><span class="line">用来实现对文档的拆分,可以将文档中的值拆分为单独的文档</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>$group</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">分组 类似groupBy</span><br><span class="line"><span class="comment">// 根据gender分组，统计结果</span></span><br><span class="line">{<span class="attr">$group</span>:{</span><br><span class="line">    <span class="attr">_id</span>:<span class="string">'$gender'</span>, <span class="comment">//分组字段</span></span><br><span class="line">    <span class="attr">counter</span>:{<span class="attr">$sum</span>:<span class="number">1</span>} <span class="comment">//统计分组结果字段</span></span><br><span class="line">}}</span><br><span class="line"><span class="comment">// 根据gender分组，并将结果的age值添加进counter数组中</span></span><br><span class="line"><span class="comment">// $列名 将某列结果加入到结果集的数组中</span></span><br><span class="line"><span class="comment">// $$ROOT 将整个文档内容加入到结果集的数组中</span></span><br><span class="line">{<span class="attr">$group</span>:{</span><br><span class="line">    <span class="attr">_id</span>:<span class="string">'$gender'</span>, <span class="comment">//分组字段</span></span><br><span class="line">    <span class="attr">counter</span>:{<span class="attr">$push</span>:<span class="string">'$age'</span>} <span class="comment">//统计分组结果字段</span></span><br><span class="line">}}</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<h4 id="六-其他"><a href="#六-其他" class="headerlink" title="六.其他"></a>六.其他</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhuwansu/p/9442443.html">MongoDB数据库添加账户认证</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/yisun123456/article/details/78591255">MongoDB操作符CSDN</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.mongoing.com/can-kao/yun-suan-fu/query-and-projection-operators">MongoDB操作符官方文档</a></p>
<h4 id="七-问题"><a href="#七-问题" class="headerlink" title="七. 问题"></a>七. 问题</h4><ol>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41672878/article/details/121801590">聚合查询时<code>$sort</code>超出内存100M限制</a></p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解决方案</span></span><br><span class="line">查询时添加 { <span class="attr">allowDiskUse</span>: <span class="literal">true</span> },允许mongo先将查询结果写入临时文件在进行排序</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<h3 id="MongoDB-应用"><a href="#MongoDB-应用" class="headerlink" title="MongoDB 应用"></a>MongoDB 应用</h3><h4 id="一-NodeJs"><a href="#一-NodeJs" class="headerlink" title="一. NodeJs"></a>一. NodeJs</h4><ol>
<li>npm安装对应的MongoDB包</li>
</ol>
<h4 id="二-Java"><a href="#二-Java" class="headerlink" title="二. Java"></a>二. Java</h4><ol>
<li>maven安装对应的MongoDB驱动</li>
</ol>
<h3 id="相关测试sql"><a href="#相关测试sql" class="headerlink" title="相关测试sql"></a>相关测试sql</h3><h4 id="一-基础操作"><a href="#一-基础操作" class="headerlink" title="一.基础操作"></a>一.基础操作</h4><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//insert</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">insert</span>([{{<span class="attr">_id</span>:<span class="string">"123"</span>,<span class="attr">firstName</span>:<span class="string">'x'</span>}}])</span><br><span class="line"><span class="comment">//remove</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">remove</span>({<span class="attr">_id</span>:<span class="string">"123"</span>})</span><br><span class="line"><span class="comment">//find</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">find</span>({})</span><br><span class="line"><span class="comment">//limit 分页查询</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">find</span>().<span class="title function_">limit</span>(<span class="number">10</span>).<span class="title function_">skip</span>(<span class="number">0</span>) <span class="comment">//查询前10条</span></span><br><span class="line"><span class="comment">// sort 排序</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">find</span>().<span class="title function_">sort</span>({<span class="attr">age</span>:<span class="number">1</span>}) <span class="comment">//1：升序；-1：降序</span></span><br><span class="line"><span class="comment">// 比较操作符</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">find</span>({<span class="attr">age</span>:{<span class="attr">$gte</span>:<span class="number">10</span>}})</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组操作符</span></span><br><span class="line"><span class="comment">// $push 数组追写入数据</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">update</span>({<span class="attr">lastName</span>:<span class="string">'四'</span>},{</span><br><span class="line">	<span class="attr">$push</span>:{<span class="attr">course</span>:<span class="string">'物理'</span>}</span><br><span class="line">},{})</span><br><span class="line"><span class="comment">// $pop 删除数组字段中的第一个或最后一个元素 </span></span><br><span class="line"><span class="comment">// $elemMatch</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">find</span>({<span class="attr">course</span>:{<span class="attr">$elemMatch</span>:{<span class="attr">name</span>:<span class="string">'英语'</span>,<span class="attr">count</span>:{<span class="attr">$lte</span>:<span class="number">7</span>}}}})</span><br><span class="line"><span class="comment">// $size</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">find</span>( { <span class="attr">course</span>: { <span class="attr">$size</span>: <span class="number">2</span> } } )</span><br><span class="line"><span class="comment">// 更新操作符</span></span><br><span class="line"><span class="comment">// $set</span></span><br><span class="line"><span class="comment">//$setOnInsert bulkWrite事件源导入</span></span><br><span class="line">{</span><br><span class="line">          <span class="attr">updateOne</span>: {</span><br><span class="line">            <span class="attr">filter</span>: { <span class="attr">_id</span>: current.<span class="property">_id</span> },</span><br><span class="line">            <span class="attr">update</span>: {</span><br><span class="line">              <span class="attr">$set</span>: _.<span class="title function_">omit</span>(current, <span class="string">'_id'</span>),</span><br><span class="line">              <span class="attr">$setOnInsert</span>: { <span class="attr">createdAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>() }</span><br><span class="line">            },</span><br><span class="line">            <span class="attr">upsert</span>: <span class="literal">true</span></span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h4 id="二-聚合查询"><a href="#二-聚合查询" class="headerlink" title="二.聚合查询"></a>二.聚合查询</h4><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 管道操作符</span></span><br><span class="line"><span class="comment">// $project</span></span><br><span class="line"><span class="comment">// 别名</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">aggregate</span>(</span><br><span class="line">    [</span><br><span class="line">        {</span><br><span class="line">        <span class="attr">$match</span>:{<span class="attr">gender</span>:<span class="string">'男'</span>}</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">       	<span class="attr">$project</span>:{</span><br><span class="line">        	<span class="string">"姓"</span>:<span class="string">'$firstName'</span>,</span><br><span class="line">        	<span class="string">"名"</span>:<span class="string">'$lastName'</span>,</span><br><span class="line">		      <span class="string">"年龄"</span>:<span class="string">"$age"</span></span><br><span class="line">        	}</span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"><span class="comment">// 显示某列</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  {<span class="attr">$project</span>:{<span class="attr">_id</span>:<span class="number">0</span>,<span class="attr">firstName</span>:<span class="number">1</span>,<span class="attr">lastName</span>:<span class="number">1</span>}}</span><br><span class="line">])</span><br><span class="line"><span class="comment">// 运算</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  {<span class="attr">$project</span>:{<span class="attr">firstName</span>:<span class="number">1</span>,<span class="attr">lastName</span>:<span class="number">1</span>,<span class="attr">age</span>:{<span class="string">"$add"</span>:[<span class="string">"$age"</span>,<span class="number">10</span>]}}}</span><br><span class="line">])</span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  {<span class="attr">$project</span>:{<span class="attr">firstName</span>:<span class="number">1</span>,<span class="attr">lastName</span>:<span class="number">1</span>,<span class="attr">isAdult</span>:{<span class="string">"$gt"</span>:[<span class="string">"$age"</span>,<span class="number">18</span>]}}}</span><br><span class="line">])</span><br><span class="line"><span class="comment">// $group</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">	{<span class="attr">$group</span>:{</span><br><span class="line">    <span class="attr">_id</span>:<span class="string">'$gender'</span>, <span class="comment">//分组字段</span></span><br><span class="line">    <span class="attr">counter</span>:{<span class="attr">$push</span>:<span class="string">'$age'</span>} <span class="comment">//统计分组结果字段</span></span><br><span class="line">}}])</span><br><span class="line"><span class="comment">// $addFields</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  {<span class="attr">$project</span>:{<span class="attr">_id</span>:<span class="number">0</span>,<span class="attr">firstName</span>:<span class="number">1</span>,<span class="attr">lastName</span>:<span class="number">1</span>,<span class="attr">age</span>:<span class="number">1</span>}},</span><br><span class="line">  {<span class="attr">$addFields</span>:{</span><br><span class="line">    <span class="attr">avgAge</span>:{<span class="string">"$add"</span>:[<span class="string">'$age'</span>,<span class="number">20</span>]}</span><br><span class="line">  }}</span><br><span class="line">])</span><br><span class="line"><span class="comment">// $unwind</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  {<span class="attr">$project</span>:{<span class="attr">_id</span>:<span class="number">0</span>,<span class="attr">firstName</span>:<span class="number">1</span>,<span class="attr">lastName</span>:<span class="number">1</span>,<span class="attr">course</span>:<span class="number">1</span>}},</span><br><span class="line">  {<span class="attr">$unwind</span>:<span class="string">"$course"</span>}</span><br><span class="line">])</span><br><span class="line"><span class="comment">// $sort</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  {<span class="attr">$project</span>:{<span class="attr">_id</span>:<span class="number">0</span>,<span class="attr">firstName</span>:<span class="number">1</span>,<span class="attr">lastName</span>:<span class="number">1</span>,<span class="attr">age</span>:<span class="number">1</span>}},</span><br><span class="line">  {<span class="attr">$addFields</span>:{</span><br><span class="line">    <span class="attr">avgAge</span>:{<span class="string">"$add"</span>:[<span class="string">'$age'</span>,<span class="number">20</span>]}</span><br><span class="line">  }},</span><br><span class="line">	{<span class="attr">$sort</span>:{<span class="attr">age</span>:<span class="number">1</span>}}</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// $lookup</span></span><br><span class="line">db.<span class="property">test</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">$lookup</span>:{</span><br><span class="line">      <span class="attr">from</span>:<span class="string">'test1'</span>,</span><br><span class="line">      <span class="attr">localField</span>:<span class="string">'gender'</span>,</span><br><span class="line">      <span class="attr">foreignField</span>:<span class="string">'_id'</span>,</span><br><span class="line">      <span class="attr">as</span>:<span class="string">'goal'</span></span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">	{</span><br><span class="line">		<span class="attr">$match</span>:{<span class="attr">age</span>:{<span class="attr">$gte</span>:<span class="number">18</span>}}</span><br><span class="line">	},</span><br><span class="line">	{</span><br><span class="line">		<span class="attr">$project</span>:{</span><br><span class="line">			<span class="attr">firstName</span>:<span class="number">1</span>,</span><br><span class="line">			<span class="attr">lastName</span>:<span class="number">1</span>,</span><br><span class="line">			<span class="attr">age</span>:<span class="number">1</span>,</span><br><span class="line">			<span class="attr">goal</span>:{ <span class="attr">$arrayElemAt</span>: [<span class="string">'$goal'</span>, <span class="number">0</span>] }</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">])</span><br></pre></td></tr></tbody></table></figure>

<h4 id="三-相关实际SQL"><a href="#三-相关实际SQL" class="headerlink" title="三. 相关实际SQL"></a>三. 相关实际SQL</h4><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">// 通过modelId获取采集规则和型号名称</span></span><br><span class="line">			<span class="keyword">const</span> pipeline = [</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">$match</span>: {</span><br><span class="line">            <span class="attr">model</span>: <span class="string">"606136aedaa355a6e23d7671"</span>,</span><br><span class="line">            <span class="attr">deleted</span>: <span class="literal">false</span></span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">$project</span>: {</span><br><span class="line">            <span class="attr">_id</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">proto</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">model</span>: <span class="number">1</span></span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">$addFields</span>: {</span><br><span class="line">            <span class="attr">modelIdAsObj</span>: {</span><br><span class="line">              <span class="attr">$toObjectId</span>: <span class="string">'$model'</span></span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">$lookup</span>: {</span><br><span class="line">            <span class="attr">from</span>: <span class="string">'assets_model'</span>,</span><br><span class="line">            <span class="attr">localField</span>: <span class="string">'modelIdAsObj'</span>,</span><br><span class="line">            <span class="attr">foreignField</span>: <span class="string">'_id'</span>,</span><br><span class="line">            <span class="attr">as</span>: <span class="string">'items'</span></span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">$replaceRoot</span>: {</span><br><span class="line">            <span class="attr">newRoot</span>: {</span><br><span class="line">              <span class="attr">$mergeObjects</span>: [</span><br><span class="line">                {</span><br><span class="line">                  <span class="attr">$arrayElemAt</span>: [<span class="string">'$items'</span>, <span class="number">0</span>]</span><br><span class="line">                },</span><br><span class="line">                <span class="string">'$$ROOT'</span></span><br><span class="line">              ]</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">$project</span>: {</span><br><span class="line">            <span class="attr">_id</span>: { <span class="attr">$toString</span>: <span class="string">'$_id'</span> },</span><br><span class="line">            <span class="attr">proto</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">name</span>: <span class="number">1</span></span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">db.<span class="property">gather_rules</span>.<span class="title function_">aggregate</span>(pipeline, {})</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传文件聚合查询</span></span><br><span class="line">db.<span class="title function_">getCollection</span>(<span class="string">'fs.chunks'</span>).<span class="title function_">aggregate</span>(</span><br><span class="line">[</span><br><span class="line">{</span><br><span class="line">   <span class="attr">$lookup</span>:{</span><br><span class="line">       <span class="attr">from</span>:<span class="string">"fs.files"</span>,</span><br><span class="line">       <span class="attr">let</span>: { <span class="attr">fdsfds</span>: <span class="string">'$files_id'</span> }, <span class="comment">// 定义fdsfds</span></span><br><span class="line">       <span class="attr">pipeline</span>:[</span><br><span class="line">       {</span><br><span class="line">           <span class="attr">$match</span>: {</span><br><span class="line">            <span class="attr">$expr</span>: {</span><br><span class="line">                    <span class="attr">$eq</span>: [<span class="string">'$_id'</span>, <span class="string">'$$fdsfds'</span>] <span class="comment">//关联</span></span><br><span class="line">            }</span><br><span class="line">     </span><br><span class="line">          }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">          <span class="attr">$project</span>:{</span><br><span class="line">              <span class="attr">_id</span>:<span class="number">0</span>,</span><br><span class="line">              <span class="attr">contentType</span>:<span class="number">1</span></span><br><span class="line">              }</span><br><span class="line">          }</span><br><span class="line">       ],</span><br><span class="line">       <span class="attr">as</span>:<span class="string">'files'</span></span><br><span class="line">       }</span><br><span class="line">    }</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"><span class="comment">// 门禁事件聚合查询</span></span><br><span class="line">db.<span class="property">gate_event</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">{</span><br><span class="line">    <span class="attr">$lookup</span>:{</span><br><span class="line">        <span class="attr">from</span>:<span class="string">'assets_unit'</span>,</span><br><span class="line">        <span class="attr">let</span>:{<span class="attr">dd</span>: { <span class="attr">$toObjectId</span>: <span class="string">'$did'</span> }}, <span class="comment">// 创建变量dd</span></span><br><span class="line">        <span class="attr">pipeline</span>:[</span><br><span class="line">          {</span><br><span class="line">          <span class="attr">$match</span>:{</span><br><span class="line">                      <span class="attr">$expr</span>: {</span><br><span class="line">                            <span class="attr">$eq</span>: [<span class="string">'$_id'</span>, <span class="string">'$$dd'</span>], <span class="comment">//关联</span></span><br><span class="line">                    },</span><br><span class="line">                    <span class="attr">name</span>:<span class="regexp">/2/</span>  <span class="comment">//名称正则</span></span><br><span class="line">          }</span><br><span class="line">          }</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">as</span>:<span class="string">'door'</span></span><br><span class="line">        }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">            <span class="attr">$project</span>:{</span><br><span class="line">                <span class="attr">door</span>:{<span class="attr">$arrayElemAt</span>:[<span class="string">"$door"</span>,<span class="number">0</span>]}</span><br><span class="line">                }</span><br><span class="line">            },        {</span><br><span class="line">            <span class="attr">$project</span>:{ </span><br><span class="line">                <span class="attr">door</span>:<span class="string">"$door.name"</span></span><br><span class="line">                }</span><br><span class="line">            },</span><br><span class="line">], {})</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分组统计下发的门禁控制器 双人开门组的数量,聚合物查询门禁的名称，实际支持的最大双人开门数量</span></span><br><span class="line">db.ac_authorized_account_group.aggregate( <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          $match<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            'uType.type'<span class="punctuation">:</span> 'double'<span class="punctuation">,</span></span><br><span class="line">            deleted<span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          $group<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            _id<span class="punctuation">:</span> '$authorizedAssets.parentId'<span class="punctuation">,</span></span><br><span class="line">            count<span class="punctuation">:</span> <span class="punctuation">{</span> $sum<span class="punctuation">:</span> <span class="number">1</span> <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            _id<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              $arrayElemAt<span class="punctuation">:</span> <span class="punctuation">[</span>'$_id'<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            count<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          $lookup<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            from<span class="punctuation">:</span> 'assets_device'<span class="punctuation">,</span></span><br><span class="line">            let<span class="punctuation">:</span> <span class="punctuation">{</span> id<span class="punctuation">:</span> <span class="punctuation">{</span> $toObjectId<span class="punctuation">:</span> '$_id' <span class="punctuation">}</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            pipeline<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">{</span></span><br><span class="line">                $match<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                  deleted<span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                  $expr<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                    $eq<span class="punctuation">:</span> <span class="punctuation">[</span>'$_id'<span class="punctuation">,</span> '$$id'<span class="punctuation">]</span></span><br><span class="line">                  <span class="punctuation">}</span></span><br><span class="line">                <span class="punctuation">}</span></span><br><span class="line">              <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">{</span></span><br><span class="line">                $addFields<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                  countParams<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                    $filter<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                      input<span class="punctuation">:</span> '$params'<span class="punctuation">,</span></span><br><span class="line">                      as<span class="punctuation">:</span> 'item'<span class="punctuation">,</span></span><br><span class="line">                      cond<span class="punctuation">:</span> <span class="punctuation">{</span> $eq<span class="punctuation">:</span> <span class="punctuation">[</span>'$$item.code'<span class="punctuation">,</span> 'maxMultiAuthCount'<span class="punctuation">]</span> <span class="punctuation">}</span></span><br><span class="line">                    <span class="punctuation">}</span></span><br><span class="line">                  <span class="punctuation">}</span></span><br><span class="line">                <span class="punctuation">}</span></span><br><span class="line">              <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">{</span></span><br><span class="line">                $addFields<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                  countParam<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                    $arrayElemAt<span class="punctuation">:</span> <span class="punctuation">[</span>'$countParams'<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">                  <span class="punctuation">}</span></span><br><span class="line">                <span class="punctuation">}</span></span><br><span class="line">              <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">{</span></span><br><span class="line">                $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                  _id<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                  name<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                  countParam<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">}</span></span><br><span class="line">              <span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            as<span class="punctuation">:</span> 'devices'</span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">         <span class="punctuation">{</span></span><br><span class="line">          $addFields<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            deviceParam<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              $arrayElemAt<span class="punctuation">:</span> <span class="punctuation">[</span>'$devices'<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">{</span></span><br><span class="line">          $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            deviceParam<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            count<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span><span class="punctuation">{</span><span class="punctuation">}</span>)</span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 备品备件 聚合分组查询</span></span><br><span class="line">db.spare_parts.aggregate(<span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    $match<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      model<span class="punctuation">:</span> ''<span class="punctuation">,</span></span><br><span class="line">      deleted<span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      storeHouses<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      applicableDevice<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      maintainEntrys<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      count<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span> <span class="punctuation">{</span></span><br><span class="line">    $unwind<span class="punctuation">:</span> '$storeHouses'</span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    $group<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      _id<span class="punctuation">:</span> '$storeHouses.id'<span class="punctuation">,</span></span><br><span class="line">      result<span class="punctuation">:</span> <span class="punctuation">{</span> $push<span class="punctuation">:</span> '$$ROOT' <span class="punctuation">}</span></span><br><span class="line"></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span> $unwind<span class="punctuation">:</span> '$result' <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    $addFields<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      count<span class="punctuation">:</span> '$result.count'<span class="punctuation">,</span></span><br><span class="line">      applicableDevice<span class="punctuation">:</span> '$result.applicableDevice'<span class="punctuation">,</span></span><br><span class="line">      storeHouse<span class="punctuation">:</span> '$result.storeHouses'<span class="punctuation">,</span></span><br><span class="line">      maintainEntrys<span class="punctuation">:</span>'$result.maintainEntrys'</span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      _id<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      count<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      applicableDevice<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      storeHouse<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      maintainEntrys<span class="punctuation">:</span><span class="number">1</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span> <span class="punctuation">{</span><span class="punctuation">}</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 备品备件 聚合分组查询</span></span><br><span class="line">db.spare_parts.aggregate(<span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    $match<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      model<span class="punctuation">:</span> ''<span class="punctuation">,</span></span><br><span class="line">      deleted<span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      storeHouses<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      applicableDevice<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      maintainEntrys<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span> <span class="punctuation">{</span></span><br><span class="line">    $unwind<span class="punctuation">:</span> '$maintainEntrys'</span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    $group<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        _id<span class="punctuation">:</span> <span class="punctuation">{</span>st<span class="punctuation">:</span>'$maintainEntrys.storeHouse.id'<span class="punctuation">,</span>app<span class="punctuation">:</span>'$applicableDevice.serialno'<span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      result<span class="punctuation">:</span> <span class="punctuation">{</span> $push<span class="punctuation">:</span> '$$ROOT' <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      total<span class="punctuation">:</span><span class="punctuation">{</span>$sum<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">   <span class="punctuation">{</span></span><br><span class="line">    $addFields<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      applicableDevice<span class="punctuation">:</span> '$result.applicableDevice'<span class="punctuation">,</span></span><br><span class="line">      storeHouse<span class="punctuation">:</span> '$result.maintainEntrys.storeHouse'<span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">   <span class="punctuation">{</span></span><br><span class="line">    $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">      _id<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      applicableDevice<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      storeHouse<span class="punctuation">:</span> <span class="punctuation">{</span>$arrayElemAt<span class="punctuation">:</span><span class="punctuation">[</span>'$storeHouse'<span class="punctuation">,</span><span class="number">0</span><span class="punctuation">]</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      total<span class="punctuation">:</span><span class="number">1</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span> <span class="punctuation">{</span><span class="punctuation">}</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//更新安保布防数据结构</span></span><br><span class="line">      db.getCollection('defence_withdraw').find(<span class="punctuation">{</span> gateDoor<span class="punctuation">:</span> <span class="punctuation">{</span> $exists<span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span> <span class="punctuation">}</span> <span class="punctuation">}</span>).forEach(r =&gt; <span class="punctuation">{</span></span><br><span class="line">        const gateDoor = <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        r.defenceInfo = r.defenceInfo.map(d =&gt; <span class="punctuation">{</span></span><br><span class="line">          d.gateDoor.map(g =&gt; <span class="punctuation">{</span></span><br><span class="line">            gateDoor.push(g)</span><br><span class="line">          <span class="punctuation">}</span>)</span><br><span class="line">          delete d.gateDoor</span><br><span class="line">          return d</span><br><span class="line">        <span class="punctuation">}</span>)</span><br><span class="line">        db.defence_withdraw.updateOne(</span><br><span class="line">          <span class="punctuation">{</span> _id<span class="punctuation">:</span> r._id <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $set<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              defenceInfo<span class="punctuation">:</span> r.defenceInfo<span class="punctuation">,</span></span><br><span class="line">              gateDoor<span class="punctuation">:</span> gateDoor</span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        )</span><br><span class="line">      <span class="punctuation">}</span>)</span><br><span class="line">  db.getCollection('defence_withdraw_results').find(<span class="punctuation">{</span> 'defenceInfo.locationId'<span class="punctuation">:</span> <span class="punctuation">{</span> $exists<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span> <span class="punctuation">}</span> <span class="punctuation">}</span>).forEach(r =&gt; <span class="punctuation">{</span></span><br><span class="line">    const gateDoor = <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">    r.defenceInfo = r.defenceInfo.map(d =&gt; <span class="punctuation">{</span></span><br><span class="line">      d.gateDoor.map(g =&gt; <span class="punctuation">{</span></span><br><span class="line">        g.defence = d.defence</span><br><span class="line">        g.withdraw = d.withdraw</span><br><span class="line">        gateDoor.push(g)</span><br><span class="line">      <span class="punctuation">}</span>)</span><br><span class="line">      delete d.gateDoor</span><br><span class="line">      return d</span><br><span class="line">    <span class="punctuation">}</span>)</span><br><span class="line">    db.defence_withdraw_results.updateOne(</span><br><span class="line">      <span class="punctuation">{</span> _id<span class="punctuation">:</span> r._id <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">{</span></span><br><span class="line">        $set<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          defenceInfo<span class="punctuation">:</span> r.defenceInfo<span class="punctuation">,</span></span><br><span class="line">          gateDoor<span class="punctuation">:</span> gateDoor</span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    )</span><br><span class="line">  <span class="punctuation">}</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// update getGateEventByFilter</span></span><br><span class="line">db.gate_event.aggregate(<span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">{</span></span><br><span class="line">      $match<span class="punctuation">:</span> <span class="punctuation">{</span>did<span class="punctuation">:</span>'<span class="number">61504282630337796</span>a8880e7'<span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      $lookup<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        from<span class="punctuation">:</span> 'assets_room'<span class="punctuation">,</span></span><br><span class="line">        let<span class="punctuation">:</span> <span class="punctuation">{</span> roomId<span class="punctuation">:</span> <span class="punctuation">{</span> $toObjectId<span class="punctuation">:</span> '$deviceRoomId' <span class="punctuation">}</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        pipeline<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $match<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              $expr<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                $eq<span class="punctuation">:</span> <span class="punctuation">[</span>'$_id'<span class="punctuation">,</span> '$$roomId'<span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              _id<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              name<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              deleted<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        as<span class="punctuation">:</span> 'room'</span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      $lookup<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        from<span class="punctuation">:</span> 'ac_account_usercontrol'<span class="punctuation">,</span></span><br><span class="line">        let<span class="punctuation">:</span> <span class="punctuation">{</span> p<span class="punctuation">:</span> '$pin' <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        pipeline<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $match<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              $expr<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                $eq<span class="punctuation">:</span> <span class="punctuation">[</span>'$pin'<span class="punctuation">,</span> '$$p'<span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              _id<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              accountId<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $lookup<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              from<span class="punctuation">:</span> 'accounts'<span class="punctuation">,</span></span><br><span class="line">              let<span class="punctuation">:</span> <span class="punctuation">{</span> accountId<span class="punctuation">:</span> <span class="punctuation">{</span> $toString<span class="punctuation">:</span> '$accountId' <span class="punctuation">}</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">              pipeline<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">{</span></span><br><span class="line">                  $match<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                    $expr<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                      $eq<span class="punctuation">:</span> <span class="punctuation">[</span>'$accountId'<span class="punctuation">,</span> '$$accountId'<span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">}</span></span><br><span class="line">                  <span class="punctuation">}</span></span><br><span class="line">                <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">{</span></span><br><span class="line">                  $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                    _id<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    name<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    deleted<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                  <span class="punctuation">}</span></span><br><span class="line">                <span class="punctuation">}</span></span><br><span class="line">              <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">              as<span class="punctuation">:</span> 'account'</span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $addFields<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              name<span class="punctuation">:</span> '$account.name'<span class="punctuation">,</span></span><br><span class="line">              deleted<span class="punctuation">:</span> '$account.deleted'</span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              name<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                $arrayElemAt<span class="punctuation">:</span> <span class="punctuation">[</span>'$name'<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">              deleted<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                $arrayElemAt<span class="punctuation">:</span> <span class="punctuation">[</span>'$deleted'<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        as<span class="punctuation">:</span> 'account'</span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      $lookup<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        from<span class="punctuation">:</span> 'assets_unit'<span class="punctuation">,</span></span><br><span class="line">        let<span class="punctuation">:</span> <span class="punctuation">{</span> id<span class="punctuation">:</span> <span class="punctuation">{</span> $toObjectId<span class="punctuation">:</span> '$did' <span class="punctuation">}</span> <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        pipeline<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $match<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              $expr<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                $eq<span class="punctuation">:</span> <span class="punctuation">[</span>'$_id'<span class="punctuation">,</span> '$$id'<span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              _id<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              serialno<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              aliasName<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              deleted<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        as<span class="punctuation">:</span> 'unit'</span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      $lookup<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        from<span class="punctuation">:</span> 'assets_device'<span class="punctuation">,</span></span><br><span class="line">        let<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          did<span class="punctuation">:</span> <span class="punctuation">{</span> $toObjectId<span class="punctuation">:</span> '$did' <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        pipeline<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $match<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              $expr<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                $eq<span class="punctuation">:</span> <span class="punctuation">[</span>'$_id'<span class="punctuation">,</span> '$$did'<span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">{</span></span><br><span class="line">            $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">              _id<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">              serialno<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              name<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">              deleted<span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">          <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        as<span class="punctuation">:</span> 'deviceUnit'</span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">      $project<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        key<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        deviceData<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        did<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        mid<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        orgId<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        deviceroomId<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        pid<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        pin<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        cardno<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        doorId<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        event<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        inoutstatus<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        verifytype<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        time<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        eventValue<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        inoutValue<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        verifyTypeValue<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        deviceUnit<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          $arrayElemAt<span class="punctuation">:</span> <span class="punctuation">[</span>'$deviceUnit'<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        room<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          $arrayElemAt<span class="punctuation">:</span> <span class="punctuation">[</span>'$room'<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        unit<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          $arrayElemAt<span class="punctuation">:</span> <span class="punctuation">[</span>'$unit'<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        account<span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">          $arrayElemAt<span class="punctuation">:</span> <span class="punctuation">[</span>'$account'<span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">      <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span><span class="punctuation">{</span><span class="punctuation">}</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 门禁记录更改，存储时包含username，旧数据更新</span></span><br><span class="line">    db.<span class="title function_">gate_event</span>({ <span class="attr">username</span>: { <span class="attr">$exists</span>: <span class="literal">false</span> }, <span class="attr">deleted</span>: <span class="literal">false</span> }).<span class="title function_">forEach</span>(<span class="function"><span class="params">gateRecord</span> =&gt;</span> {</span><br><span class="line">    <span class="keyword">const</span> usercontrol = db.<span class="property">ac_account_usercontrol</span>.<span class="title function_">aggregate</span>(</span><br><span class="line">      [</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">$match</span>: {</span><br><span class="line">            <span class="attr">pin</span>: gateRecord.<span class="property">pin</span></span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          <span class="attr">$lookup</span>: {</span><br><span class="line">            <span class="attr">from</span>: <span class="string">'accounts'</span>,</span><br><span class="line">            <span class="attr">let</span>: { <span class="attr">id</span>: { <span class="attr">$toObjectId</span>: <span class="string">'$accountKey'</span> } },</span><br><span class="line">            <span class="attr">pipeline</span>: [</span><br><span class="line">              {</span><br><span class="line">                <span class="attr">$match</span>: {</span><br><span class="line">                  <span class="attr">$expr</span>: {</span><br><span class="line">                    <span class="attr">$eq</span>: [<span class="string">'$_id'</span>, <span class="string">'$$id'</span>]</span><br><span class="line">                  }</span><br><span class="line">                }</span><br><span class="line">              },</span><br><span class="line">              {</span><br><span class="line">                <span class="attr">$project</span>: {</span><br><span class="line">                  <span class="attr">_id</span>: <span class="number">0</span>,</span><br><span class="line">                  <span class="attr">name</span>: <span class="number">1</span></span><br><span class="line">                }</span><br><span class="line">              }</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">as</span>: <span class="string">'account'</span></span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    )</span><br><span class="line">    db.<span class="property">gate_event</span>.<span class="title function_">updateOne</span>({ <span class="attr">_id</span>: gateRecord.<span class="property">_id</span> }, { <span class="attr">$set</span>: { <span class="attr">username</span>: usercontrol[<span class="number">0</span>].<span class="property">name</span> } })</span><br><span class="line">  })</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 布防方案增加布防模式，旧数据更新</span></span><br><span class="line">db.<span class="property">defence_withdraw</span>.<span class="title function_">updateMany</span>({<span class="attr">deleted</span>:<span class="literal">false</span>,<span class="attr">repeat</span>: { <span class="attr">$exists</span>: <span class="literal">false</span> } },{ <span class="attr">$set</span>: { <span class="attr">repeat</span>: { <span class="attr">mode</span>: <span class="string">'daily'</span>, <span class="attr">value</span>: [<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'0'</span>] } } })</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 门禁发卡增加有效期，旧数据默认为长期有效</span></span><br><span class="line">db.<span class="property">ac_authorized_account_group</span>.<span class="title function_">update</span>({<span class="attr">validity</span>:{<span class="attr">$exists</span>:<span class="literal">false</span>},<span class="attr">deleted</span>:<span class="literal">false</span>},{<span class="attr">$set</span>: { validity : {</span><br><span class="line">  <span class="attr">type</span>:<span class="string">'long'</span>,</span><br><span class="line">  <span class="attr">time</span>:{</span><br><span class="line">    <span class="attr">startTime</span>:<span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">    <span class="attr">endTime</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">setFullYear</span>(<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getFullYear</span>() + <span class="number">100</span>))</span><br><span class="line">  }</span><br><span class="line">}}})</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新安保布防的ownerId</span></span><br><span class="line">db.<span class="property">defence_withdraw</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">      {</span><br><span class="line">        <span class="attr">$match</span>:{ <span class="attr">deleted</span>: <span class="literal">false</span> }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line"></span><br><span class="line">          <span class="attr">$lookup</span>: {</span><br><span class="line">        <span class="attr">from</span>: <span class="string">'employees'</span>,</span><br><span class="line">        <span class="attr">let</span>: { <span class="attr">ownerId</span>:  <span class="string">'$ownerId'</span> },</span><br><span class="line">        <span class="attr">pipeline</span>: [</span><br><span class="line">          {</span><br><span class="line">            <span class="attr">$match</span>: {</span><br><span class="line">              <span class="attr">deleted</span>:<span class="literal">false</span>,</span><br><span class="line">              <span class="attr">$expr</span>: {</span><br><span class="line">                <span class="attr">$eq</span>: [<span class="string">'$employeId'</span>, <span class="string">'$$ownerId'</span>]</span><br><span class="line">              }</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">as</span>: <span class="string">'employees'</span></span><br><span class="line">      }</span><br><span class="line">      },</span><br><span class="line">    ],{}).<span class="title function_">forEach</span>(<span class="function"><span class="params">defence</span>=&gt;</span>{</span><br><span class="line">      <span class="keyword">if</span>(defence.<span class="property">employees</span>[<span class="number">0</span>]){</span><br><span class="line">       db.<span class="property">defence_withdraw</span>.<span class="title function_">updateOne</span>({ <span class="attr">_id</span>: defence.<span class="property">_id</span> }, { <span class="attr">$set</span>: { ownerId : defence.<span class="property">employees</span>[<span class="number">0</span>].<span class="property">employerId</span> } })</span><br><span class="line">      }</span><br><span class="line">    })</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新门禁发卡用户中间表</span></span><br><span class="line">db.<span class="property">ac_account_usercontrol</span>.<span class="title function_">find</span>({<span class="attr">deleted</span>:<span class="literal">false</span>}).<span class="title function_">forEach</span>(<span class="function"><span class="params">usercontrol</span>=&gt;</span>{</span><br><span class="line">    <span class="keyword">let</span> account = db.<span class="property">accounts</span>.<span class="title function_">findOne</span>({<span class="attr">accountId</span>:usercontrol.<span class="property">accountId</span>})</span><br><span class="line">    <span class="keyword">let</span> obj ={</span><br><span class="line">      <span class="attr">accountKey</span>:account.<span class="property">_id</span>,</span><br><span class="line">    }</span><br><span class="line">     db.<span class="property">ac_account_usercontrol</span>.<span class="title function_">updateOne</span>({ <span class="attr">_id</span>: usercontrol.<span class="property">_id</span> }, { <span class="attr">$set</span>: obj })</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出一周巡更记录优化后相关sql 更改了主从表关联顺序</span></span><br><span class="line">[{</span><br><span class="line">		<span class="string">"$project"</span>: {</span><br><span class="line">			<span class="string">"result.editable"</span>: <span class="number">0</span>,</span><br><span class="line">			<span class="string">"result.disabled"</span>: <span class="number">0</span>,</span><br><span class="line">			<span class="string">"result.assetStatus"</span>: <span class="number">0</span>,</span><br><span class="line">			<span class="string">"result.paramSourceType"</span>: <span class="number">0</span></span><br><span class="line">		}</span><br><span class="line">	}, {</span><br><span class="line">		<span class="string">"$match"</span>: {</span><br><span class="line">			<span class="string">"deleted"</span>: <span class="literal">false</span>,</span><br><span class="line">			<span class="string">"ownerId"</span>: <span class="string">"admin"</span>,</span><br><span class="line">			<span class="string">"scanAt"</span>: {</span><br><span class="line">				<span class="string">"$gte"</span>: <span class="title class_">ISODate</span>(<span class="string">"2022-09-07T16:00:00.000Z"</span>),</span><br><span class="line">				<span class="string">"$lte"</span>: <span class="title class_">ISODate</span>(<span class="string">"2022-09-15T15:59:59.999Z"</span>)</span><br><span class="line">			},</span><br><span class="line">			<span class="string">"planId"</span>: <span class="string">"63058d26cb8c29160ef1482f"</span></span><br><span class="line">		}</span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">	{</span><br><span class="line">		<span class="string">"$lookup"</span>: {</span><br><span class="line">			<span class="string">"from"</span>: <span class="string">"patrol_points"</span>,</span><br><span class="line">			<span class="string">"let"</span>: {</span><br><span class="line">				<span class="string">"pointIdAsObj"</span>: {</span><br><span class="line">					<span class="string">"$toObjectId"</span>: <span class="string">"$pointId"</span></span><br><span class="line">				}</span><br><span class="line">			},</span><br><span class="line">			<span class="string">"pipeline"</span>: [{</span><br><span class="line">				<span class="string">"$match"</span>: {</span><br><span class="line">					<span class="string">"$expr"</span>: {</span><br><span class="line">						<span class="string">"$eq"</span>: [<span class="string">"$_id"</span>, <span class="string">"$$pointIdAsObj"</span>]</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">			}, {</span><br><span class="line">				<span class="string">"$project"</span>: {</span><br><span class="line">					<span class="string">"_id"</span>: <span class="number">0</span>,</span><br><span class="line">					<span class="string">"locationId"</span>: <span class="number">1</span>,</span><br><span class="line">					<span class="string">"locationType"</span>: <span class="number">1</span>,</span><br><span class="line">					<span class="string">"locationName"</span>: <span class="number">1</span></span><br><span class="line">				}</span><br><span class="line">			}],</span><br><span class="line">			<span class="string">"as"</span>: <span class="string">"pointDetail"</span></span><br><span class="line">		}</span><br><span class="line">	}, {</span><br><span class="line">		<span class="string">"$addFields"</span>: {</span><br><span class="line">			<span class="string">"pointDetail"</span>: {</span><br><span class="line">				<span class="string">"$arrayElemAt"</span>: [<span class="string">"$pointDetail"</span>, <span class="number">0</span>]</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}, {</span><br><span class="line">		<span class="string">"$group"</span>: {</span><br><span class="line">			<span class="string">"_id"</span>: {</span><br><span class="line">				<span class="string">"planId"</span>: <span class="string">"$planId"</span>,</span><br><span class="line">				<span class="string">"schedule"</span>: <span class="string">"$schedule"</span></span><br><span class="line">			},</span><br><span class="line">			<span class="string">"records"</span>: {</span><br><span class="line">				<span class="string">"$push"</span>: <span class="string">"$$CURRENT"</span></span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	},</span><br><span class="line">	{</span><br><span class="line">		<span class="attr">$project</span>: {</span><br><span class="line">			<span class="attr">records</span>: {</span><br><span class="line">				<span class="attr">$slice</span>: [<span class="string">"$records"</span>, <span class="number">10</span>]</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	},</span><br><span class="line">	{</span><br><span class="line">		<span class="attr">$lookup</span>: {</span><br><span class="line">			<span class="attr">from</span>: <span class="string">'patrol_schedule_comments'</span>,</span><br><span class="line">			<span class="attr">let</span>: {</span><br><span class="line">				<span class="string">"comment_id"</span>: <span class="string">"$_id"</span></span><br><span class="line">			},</span><br><span class="line">			<span class="attr">pipeline</span>: [{</span><br><span class="line">				<span class="string">"$match"</span>: {</span><br><span class="line">					<span class="string">"deleted"</span>: <span class="literal">false</span>,</span><br><span class="line">					<span class="string">"ownerId"</span>: <span class="string">"admin"</span>,</span><br><span class="line">					<span class="string">"scanAt"</span>: {</span><br><span class="line">						<span class="string">"$gte"</span>: <span class="title class_">ISODate</span>(<span class="string">"2022-09-07T16:00:00.000Z"</span>),</span><br><span class="line">						<span class="string">"$lte"</span>: <span class="title class_">ISODate</span>(<span class="string">"2022-09-15T15:59:59.999Z"</span>)</span><br><span class="line">					},</span><br><span class="line">					<span class="string">"planId"</span>: <span class="string">"63058d26cb8c29160ef1482f"</span></span><br><span class="line">				},</span><br><span class="line"></span><br><span class="line">			}, {</span><br><span class="line">				<span class="string">"$skip"</span>: <span class="number">0</span></span><br><span class="line">			}, {</span><br><span class="line">				<span class="string">"$limit"</span>: <span class="number">10</span></span><br><span class="line">			}, ],</span><br><span class="line">			<span class="attr">as</span>: <span class="string">'comments'</span></span><br><span class="line">		}</span><br><span class="line">	},</span><br><span class="line">	{</span><br><span class="line">		<span class="string">"$skip"</span>: <span class="number">0</span></span><br><span class="line">	}, {</span><br><span class="line">		<span class="string">"$limit"</span>: <span class="number">10</span></span><br><span class="line">	},</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>

</div><script src="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2022-09-12</span>
            
            
             
        
        </i>
    </div>
    <br>
    
    <!-- <div class="post-footer-pre-next">
        <span>上一篇：<a href=""></a></span>
        <span class="post-footer-pre-next-last-span-right">上一篇：<a href=""></a></span>
    </div> -->

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            © 1949-2024 China 

            
                

            
        </span>
    
</div>
<!--这是指一条线往下的内容-->
<div class="footer-last">
    
            <span>Live in the moment</span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--目录-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--回到顶部按钮-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery.min.js"></script>



                </div>
            
            
                <!-- 回到顶部的按钮-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- 返回的按钮-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>


</html>